/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("sap.ca.scfld.md.app.ConnectionManager");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.ca.ui.utils.busydialog");sap.ui.base.ManagedObject.extend("sap.ca.scfld.md.app.ConnectionManager",{metadata:{properties:{identity:"string",configuration:"object",defaultConfiguration:"object",component:"object"}},initModels:function(){function a(p,A){(A||"").split("&").forEach(function(P){var i=P.indexOf("="),K=P,v="";if(i>=0){v=decodeURIComponent(K.slice(i+1));K=K.slice(0,i)}K=decodeURIComponent(K);if(K){p[K]=v}})}function c(S){var j=JSON.parse(JSON.stringify(S));jQuery.each(j,function(i,n){n.fRequestFailed=S[i].fRequestFailed});return j}this.modelList={};this.mockServerList={};this.iRequestCount=0;var s=jQuery.isArray(this.getConfiguration().getServiceList())?c(this.getConfiguration().getServiceList()):null;var e=this.getConfiguration().getExcludedQueryStringParameters()||[];var b=this.getConfiguration().isMock();var t=this;var d=jQuery.sap.getUriParameters().get("sap-server");var f=jQuery.sap.getUriParameters().get("sap-host");var g=jQuery.sap.getUriParameters().get("sap-host-http");var h=jQuery.sap.getUriParameters().get("sap-client");var C=t.getComponent();this.sErrorInStartMessage="";this.bIsComponentBase=!!C.setRouterSetCloseDialogs;this.bIsShowingMessage=false;if(!sap.ui.getCore().getConfiguration().getDisableCustomizing()&&C&&C.getMetadata()){var o=C.getMetadata().getConfig();var k=o["sap.ca.serviceConfigs"];var m=function(S,E){var n,p;var q=jQuery.isArray(E)?c(E):[];for(var i=0;i<S.length;i++){n=S[i];for(var j=0;j<q.length;j++){p=q[j];if(n.name==p.name){for(var r in p){n[r]=p[r]}q.splice(j,1);j--}}};S=S.concat(q);return S};if(k!=undefined&&k.length>0&&s!=null){var l=m(s,k);s=l}}if(s!=null){jQuery.each(s,function(i,j){function n(E,S){var w="Cannot load meta data for service "+S.serviceUrl,D=E.getParameter("statusCode"),x=t.getIdentity()||"sap.ca.scfld.md.app.ConnectionManager";D+=" (";D+=E.getParameter("statusText");D+=") - ";D+=E.getParameter("message");D+="\n";D+=E.getParameter("responseText");jQuery.sap.log.error(w,D,x)}var u=URI(j.serviceUrl),U=(j.useV2ODataModel===true);if(d!=null&&(jQuery.inArray("sap-server",e)==-1)){u.addSearch("sap-server",d)}else if(f!=null&&(jQuery.inArray("sap-host",e)==-1)){u.addSearch("sap-host",f)}else if(g!=null&&(jQuery.inArray("sap-host-http",e)==-1)){u.addSearch("sap-host-http",g)}if(h!=null&&(jQuery.inArray("sap-client",e)==-1)){u.addSearch("sap-client",h)}var p=u.toString();if(b){jQuery.sap.require("sap.ui.core.util.MockServer");var M=(p.split("?")[0]).replace(/\/?$/,"/");var q=new sap.ui.core.util.MockServer({rootUri:M});if(j.mockedDataSource){q.simulate(j.mockedDataSource,{sMockdataBaseUrl:j.mockedDataSource.replace(/[^\/]+$/,""),bGenerateMissingMockData:true})}else{q.simulate(M+"$metadata")}q.start();t.mockServerList[j.name]=q;if(j.isDefault){t.mockServerList[undefined]=q}}var o={metadataUrlParams:{},json:true,loadMetadataAsync:j.loadMetadataAsync===true||U};a(o.metadataUrlParams,j.metadataParams);if(j.serviceUrl.indexOf("/sap/opu/")===0){var r=sap.ushell&&sap.ushell.Container?sap.ushell.Container.getUser().getLanguage():jQuery.sap.getUriParameters().get("sap-language");if(r&&e.indexOf("sap-language")<0){o.metadataUrlParams["sap-language"]=r}}var v=U?new sap.ui.model.odata.v2.ODataModel(p,o):new sap.ui.model.odata.ODataModel(p,o);if(o.loadMetadataAsync){v.attachMetadataLoaded({oModel:v,oService:j},function(E,P){t.checkModelMetaData(P.oModel,P.oService)},this);v.attachMetadataFailed({oModel:v,oService:j},function(E,P){n(E,P.oService);t.checkModelMetaData(P.oModel,P.oService)},this)}else{v.attachMetadataFailed(j,n,this);t.checkModelMetaData(v,j)}if(j.overrideGetPropertyMetadata&&v.oMetadata){v.oMetadata._getPropertyMetadata=function(E,P){P=P.replace(/^\/|\/$|\)$|\w*\(/g,"");return sap.ui.model.odata.ODataMetadata.prototype._getPropertyMetadata.apply(this,[E,P])}}if((j.useBatch)&&!b){v.setUseBatch(true)}if(j.countSupported){if(U){v.setDefaultCountMode(sap.ui.model.odata.CountMode.Request)}else{v.setCountSupported(true)}}else{if(U){v.setDefaultCountMode(sap.ui.model.odata.CountMode.Inline)}else{v.setCountSupported(false)}}if(j.sDefaultBindingMode){v.setDefaultBindingMode(j.sDefaultBindingMode)}if(j.fRequestFailed){v.attachRequestFailed(null,j.fRequestFailed)}else{v.attachRequestFailed(null,jQuery.proxy(t.handleRequestFailed,t))}if(j.noBusyIndicator==true){v.attachRequestSent(null,jQuery.proxy(t.handleRequestSentInner,t));v.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompletedInner,t))}else{v.attachRequestSent(null,jQuery.proxy(t.handleRequestSent,t));v.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompleted,t))}if(j.isDefault){t.modelList[undefined]=v;t.setDefaultConfiguration(j)}else{t.modelList[j.name]=v}})}},checkModelMetaData:function(m,s){if(!m.getServiceMetadata()){var i=this.getProperty("configuration").oApplicationFacade.oApplicationImplementation.UilibI18nModel.getResourceBundle();this.sErrorInStartMessage=i.getText("ERROR_MSG_NO_METADATA",[s.name]);var S={type:sap.ca.ui.message.Type.ERROR,message:this.sErrorInStartMessage,details:i.getText("ERROR_DETAIL_NO_METADATA",[s.serviceUrl])};this.showMessageBox(S);return}},setIdentity:function(i){var o=this.getIdentity();if(o!=i){this.setProperty("identity",i)}},getModel:function(n){return this.modelList[n]},handleRequestSent:function(e){sap.ca.ui.utils.busydialog.requireBusyDialog();this.handleRequestSentInner(e)},handleRequestSentInner:function(e){this.iRequestCount++;jQuery.sap.log.info("Connection Manager","Request sent")},handleRequestFailed:function(e){jQuery.sap.log.error("Connection Manager","Failed to load data");var r=e.getParameter("response"),s={type:sap.ca.ui.message.Type.ERROR,message:e.getParameter("message")||(r&&r.message),details:e.getParameter("responseText")||(r&&r.responseText)};this.showMessageBox(s)},handleRequestCompleted:function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();this.handleRequestCompletedInner(e)},handleRequestCompletedInner:function(e){if(e.getParameter("success")){jQuery.sap.log.info("Connection Manager","Request succesfully completed")}else{jQuery.sap.log.info("Connection Manager","Request completed with errors",e.getParameter("message"))}},showMessageBox:function(s){if(this.bIsShowingMessage){return}this.bIsShowingMessage=true;if(this.bIsComponentBase){var c=this.getComponent();var i=c._bRouterCloseDialogs;c.setRouterSetCloseDialogs(false)}sap.ca.ui.message.showMessageBox(s,jQuery.proxy(function(){this.bIsShowingMessage=false;if(this.bIsComponentBase){c.setRouterSetCloseDialogs(i)}},this))}});
sap.ca.scfld.md.app.ConnectionManager.getNewInstance=function(i,c,d,C){var o=new sap.ca.scfld.md.app.ConnectionManager({identity:i,configuration:c,defaultConfiguration:d,component:C});o.initModels();return o};
