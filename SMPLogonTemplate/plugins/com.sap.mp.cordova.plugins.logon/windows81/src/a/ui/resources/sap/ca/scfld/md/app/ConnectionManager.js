/*
 * Copyright (C) 2009-2013 SAP AG or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("sap.ca.scfld.md.app.ConnectionManager");jQuery.sap.require("sap.ca.ui.message.message");jQuery.sap.require("sap.ca.ui.utils.busydialog");sap.ui.base.ManagedObject.extend("sap.ca.scfld.md.app.ConnectionManager",{metadata:{properties:{identity:"string",configuration:"object",defaultConfiguration:"object",component:"object"}},initModels:function(){this.modelList={};this.mockServerList={};this.iRequestCount=0;var s=this.getConfiguration().getServiceList();var e=this.getConfiguration().getExcludedQueryStringParameters();if(e==null){e=new Array()}var a=this.getConfiguration().isMock();var t=this;var b=jQuery.sap.getUriParameters().get("sap-server");var c=jQuery.sap.getUriParameters().get("sap-host");var d=jQuery.sap.getUriParameters().get("sap-host-http");var f=jQuery.sap.getUriParameters().get("sap-client");var C=t.getComponent();this.sErrorInStartMessage="";this.bIsComponentBase=!!C.setRouterSetCloseDialogs;this.bIsShowingMessage=false;if(!sap.ui.getCore().getConfiguration().getDisableCustomizing()&&C&&C.getMetadata()){var o=C.getMetadata().getConfig();var g=o["sap.ca.serviceConfigs"];var m=function(S,E){var k,l;for(var i=0;i<S.length;i++){k=S[i];for(var j=0;j<E.length;j++){l=E[j];if(k.name==l.name){for(var n in l){k[n]=l[n]}E.splice(j,1);j--}}};S=S.concat(E);return S};if(g!=undefined&&g.length>0){var h=m(s,g);s=h}}if(s!=null){jQuery.each(s,function(i,j){var u=URI(j.serviceUrl);if(b!=null&&(jQuery.inArray("sap-server",e)==-1)){u.addSearch("sap-server",b)}else if(c!=null&&(jQuery.inArray("sap-host",e)==-1)){u.addSearch("sap-host",c)}else if(d!=null&&(jQuery.inArray("sap-host-http",e)==-1)){u.addSearch("sap-host-http",d)}if(f!=null&&(jQuery.inArray("sap-client",e)==-1)){u.addSearch("sap-client",f)}var U=u.toString();if(a){jQuery.sap.require("sap.ui.core.util.MockServer");var M=U;if(!jQuery.sap.endsWith(M,"/")){M+="/"}var k=new sap.ui.core.util.MockServer({rootUri:M});if(j.mockedDataSource){k.simulate(j.mockedDataSource,j.mockedDataSource.replace(new RegExp("[^/]*$"),""))}else{k.simulate(U+"/$metadata")}k.start();t.mockServerList[j.name]=k;if(j.isDefault){t.mockServerList[undefined]=k}}if(j.loadMetadataAsync&&j.loadMetadataAsync===true){var l=new sap.ui.model.odata.ODataModel(U,{json:true,loadMetadataAsync:j.loadMetadataAsync});l.attachMetadataLoaded({oModel:l,oService:j},function(E,p){t.checkModelMetaData(p.oModel,p.oService)},this);l.attachMetadataFailed({oModel:l,oService:j},function(E,p){t.checkModelMetaData(p.oModel,p.oService)},this)}else{var l=new sap.ui.model.odata.ODataModel(U,true);t.checkModelMetaData(l,j)}if(j.overrideGetPropertyMetadata&&l.oMetadata){l.oMetadata._getPropertyMetadata=function(E,p){p=p.replace(/^\/|\/$|\)$|\w*\(/g,"");return sap.ui.model.odata.ODataMetadata.prototype._getPropertyMetadata.apply(this,[E,p])}}if((j.useBatch)&&!a){l.setUseBatch(true)}if(j.countSupported){l.setCountSupported(true)}else{l.setCountSupported(false)}if(j.sDefaultBindingMode){l.setDefaultBindingMode(j.sDefaultBindingMode)}if(j.fRequestFailed){l.attachRequestFailed(null,j.fRequestFailed)}else{l.attachRequestFailed(null,jQuery.proxy(t.handleRequestFailed,t))}if(j.noBusyIndicator==true){l.attachRequestSent(null,jQuery.proxy(t.handleRequestSentInner,t));l.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompletedInner,t))}else{l.attachRequestSent(null,jQuery.proxy(t.handleRequestSent,t));l.attachRequestCompleted(null,jQuery.proxy(t.handleRequestCompleted,t))}if(j.isDefault){t.modelList[undefined]=l;t.setDefaultConfiguration(j)}else{t.modelList[j.name]=l}})}},checkModelMetaData:function(m,s){if(!m.getServiceMetadata()){var i=this.getProperty("configuration").oApplicationFacade.oApplicationImplementation.UilibI18nModel.getResourceBundle();this.sErrorInStartMessage=i.getText("ERROR_MSG_NO_METADATA",[s.name]);var S={type:sap.ca.ui.message.Type.ERROR,message:this.sErrorInStartMessage,details:i.getText("ERROR_DETAIL_NO_METADATA",[s.serviceUrl])};this.showMessageBox(S);return}},setIdentity:function(i){var o=this.getIdentity();if(o!=i){this.setProperty("identity",i)}},getModel:function(n){return this.modelList[n]},handleRequestSent:function(e){sap.ca.ui.utils.busydialog.requireBusyDialog();this.handleRequestSentInner(e)},handleRequestSentInner:function(e){this.iRequestCount++;jQuery.sap.log.info("Connection Manager","Request sent")},handleRequestFailed:function(e){jQuery.sap.log.error("Connection Manager","Failed to load data");var s={type:sap.ca.ui.message.Type.ERROR,message:e.getParameter("message"),details:e.getParameter("responseText")};this.showMessageBox(s)},handleRequestCompleted:function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();this.handleRequestCompletedInner(e)},handleRequestCompletedInner:function(e){if(e.getParameter("success")){jQuery.sap.log.info("Connection Manager","Request succesfully completed")}else{jQuery.sap.log.info("Connection Manager","Request completed with errors",e.getParameter("message"))}},showMessageBox:function(s){if(this.bIsShowingMessage){return}this.bIsShowingMessage=true;if(this.bIsComponentBase){var c=this.getComponent();var i=c._bRouterCloseDialogs;c.setRouterSetCloseDialogs(false)}sap.ca.ui.message.showMessageBox(s,jQuery.proxy(function(){this.bIsShowingMessage=false;if(this.bIsComponentBase){c.setRouterSetCloseDialogs(i)}},this))}});
sap.ca.scfld.md.app.ConnectionManager.getNewInstance=function(i,c,d,C){var o=new sap.ca.scfld.md.app.ConnectionManager({identity:i,configuration:c,defaultConfiguration:d,component:C});o.initModels();return o};
